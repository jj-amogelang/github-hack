<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <title>Geographic Health Trends</title>
</head>
<body>
    <div class="sidebar">
        <h2>DumelaHealth</h2>
        <ul>
            <li><a href="/"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
            <li><a href="/geographic"><i class="fas fa-globe"></i> Geographic Health Trends</a></li>
            <li><a href="/user-data"><i class="fas fa-user-md"></i> User Data</a></li>
            <li><a href="/ai-insights"><i class="fas fa-brain"></i> AI Insights & Recommendations</a></li>
            <li><a href="/notifications"><i class="fas fa-bell"></i> Notifications and Alerts</a></li>
            <li><a href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
    </div>
    <div class="main-content">
        <header class="navbar">
            <div class="navbar-content">
                <div class="search-container">
                    <input type="text" placeholder="Search here...">
                </div>
                <div class="user-info">
                    <div class="icon-container">
                        <span class="icon">ðŸ””</span> <!-- Notifications Icon -->
                    </div>
                    <div class="profile">
                        <span>{{ username }}</span>
                        <img src="path/to/profile-pic.jpg" alt="Profile" class="profile-pic"> <!-- Profile Picture -->
                    </div>
                </div>
            </div>
        </header>
        
        <section class="interactive-map">
            <h3>Interactive Map</h3>
            <div id="map" style="height: 500px;"></div>
            <div class="filters">
                <label for="time-period">Time Period:</label>
                <select id="time-period">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                </select>
                <label for="condition">Condition:</label>
                <select id="condition">
                    <option value="all">All Conditions</option>
                    <option value="Respiratory Infection">Respiratory Infection</option>
                    <option value="Fever">Fever</option>
                    <option value="Hypertension">Hypertension</option>
                    <option value="Diabetes">Diabetes</option>
                    <option value="Asthma">Asthma</option>
                </select>
                <button onclick="applyFilters()">Apply Filters</button>
            </div>
        </section>

        <section class="top-affected-regions">
            <h3>Top Affected Regions</h3>
            <table>
                <thead>
                    <tr>
                        <th>Area</th>
                        <th>Condition</th>
                        <th>Count</th>
                    </tr>
                </thead>
                <tbody id="top-affected-regions-body">
                    <!-- Data will be inserted here by JavaScript -->
                </tbody>
            </table>
        </section>

        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        <script>
            var map = L.map('map').setView([-26.2041, 28.0473], 13); // Johannesburg coordinates

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            function applyFilters() {
                var timePeriod = document.getElementById('time-period').value;
                var condition = document.getElementById('condition').value;

                fetch(`/api/geographic-data?time_period=${timePeriod}&condition=${condition}`)
                    .then(response => response.json())
                    .then(data => {
                        // Clear existing markers
                        map.eachLayer((layer) => {
                            if (layer instanceof L.Marker) {
                                map.removeLayer(layer);
                            }
                        });

                        // Add new markers
                        data.forEach(item => {
                            L.marker([item.lat, item.lng]).addTo(map)
                                .bindPopup(`<b>${item.area}</b><br>${item.medical_condition}`);
                        });
                    });

                fetch(`/api/top-affected-regions?time_period=${timePeriod}&condition=${condition}`)
                    .then(response => response.json())
                    .then(data => {
                        var tbody = document.getElementById('top-affected-regions-body');
                        tbody.innerHTML = ''; // Clear existing rows
                        data.forEach(item => {
                            var row = document.createElement('tr');
                            row.innerHTML = `<td>${item.area}</td><td>${item.medical_condition}</td><td>${item.count}</td>`;
                            tbody.appendChild(row);
                        });
                    });
            }

            // Initial load
            applyFilters();
        </script>
    </div>
</body>
</html>